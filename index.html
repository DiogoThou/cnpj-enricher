<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM Hub | Enriquecimento CNPJ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.95;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .card h2 {
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-badge.connected {
      background: #d4edda;
      color: #155724;
    }

    .status-badge.disconnected {
      background: #f8d7da;
      color: #721c24;
    }

    .status-badge.pending {
      background: #fff3cd;
      color: #856404;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-warning {
      background: #ffc107;
      color: #333;
    }

    pre {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      overflow-x: auto;
      font-size: 0.9rem;
      line-height: 1.5;
      max-height: 400px;
      overflow-y: auto;
    }

    .steps {
      counter-reset: step;
      margin: 20px 0;
    }

    .step {
      margin: 15px 0;
      padding-left: 40px;
      position: relative;
      counter-increment: step;
    }

    .step:before {
      content: counter(step);
      position: absolute;
      left: 0;
      top: 0;
      background: #667eea;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .step.completed:before {
      background: #28a745;
      content: "‚úì";
    }

    .alert {
      padding: 12px 20px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,.1);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 0.8s ease infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    code {
      background: #f1f3f5;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }

    .env-vars {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }

    .env-vars li {
      margin: 8px 0;
      list-style: none;
    }

    .env-vars li:before {
      content: "‚Üí";
      color: #667eea;
      font-weight: bold;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöÄ Enriquecimento de CNPJ</h1>
      <p>App HubSpot para enriquecimento autom√°tico de dados empresariais</p>
    </div>

    <!-- Card de Status -->
    <div class="card">
      <h2>
        üìä Status do Sistema
        <span id="status-badge" class="status-badge pending">Verificando...</span>
      </h2>
      
      <div id="status-details" class="alert alert-info">
        <div class="loading"></div> Verificando conex√£o...
      </div>
    </div>

    <!-- Card de Instala√ß√£o -->
    <div class="card">
      <h2>üîß Instala√ß√£o do App</h2>
      
      <div class="steps">
        <div class="step" id="step-1">
          <strong>Configurar vari√°veis de ambiente no Vercel</strong>
          <div class="env-vars">
            <ul>
              <li><code>HUBSPOT_CLIENT_ID</code> - ID do aplicativo</li>
              <li><code>HUBSPOT_CLIENT_SECRET</code> - Secret do aplicativo</li>
              <li><code>HUBSPOT_REDIRECT_URI</code> - https://seu-app.vercel.app/api/oauth/callback</li>
            </ul>
          </div>
        </div>
        
        <div class="step" id="step-2">
          <strong>Autorizar o app no HubSpot</strong>
          <p>Clique no bot√£o abaixo para iniciar o fluxo OAuth:</p>
          <div class="button-group">
            <button id="btn-install" class="btn-primary" disabled>
              üîê Instalar no HubSpot
            </button>
          </div>
        </div>
        
        <div class="step" id="step-3">
          <strong>Criar campos no CRM</strong>
          <p>Ap√≥s autorizar, crie os campos necess√°rios:</p>
          <div class="button-group">
            <button id="btn-create" class="btn-success" disabled>
              ‚ûï Criar Campos
            </button>
            <button id="btn-test" class="btn-info" disabled>
              üß™ Teste (Dry Run)
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Card de Logs -->
    <div class="card">
      <h2>üìù Logs do Sistema</h2>
      <pre id="logs">Aguardando a√ß√µes...</pre>
    </div>
  </div>

  <script>
    // Elementos
    const statusBadge = document.getElementById('status-badge');
    const statusDetails = document.getElementById('status-details');
    const logs = document.getElementById('logs');
    const btnInstall = document.getElementById('btn-install');
    const btnCreate = document.getElementById('btn-create');
    const btnTest = document.getElementById('btn-test');
    
    // Fun√ß√µes auxiliares
    function log(message, data = null) {
      const timestamp = new Date().toLocaleTimeString('pt-BR');
      const entry = `[${timestamp}] ${message}`;
      
      if (data) {
        logs.textContent = entry + '\n' + JSON.stringify(data, null, 2) + '\n\n' + logs.textContent;
      } else {
        logs.textContent = entry + '\n' + logs.textContent;
      }
    }

    function updateStatus(status, message, type = 'info') {
      statusBadge.className = `status-badge ${status}`;
      statusBadge.textContent = status === 'connected' ? 'Conectado' : 
                                status === 'disconnected' ? 'Desconectado' : 
                                'Pendente';
      
      statusDetails.className = `alert alert-${type}`;
      statusDetails.innerHTML = message;
    }

    // Verificar par√¢metros da URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      log('‚úÖ OAuth conclu√≠do com sucesso!');
      updateStatus('connected', '‚úÖ Autoriza√ß√£o OAuth conclu√≠da com sucesso!', 'success');
      document.getElementById('step-2').classList.add('completed');
      // Limpar URL
      window.history.replaceState({}, document.title, '/');
    }

    // Verificar status inicial
    async function checkStatus() {
      try {
        log('Verificando status...');
        
        const response = await fetch('/api/setup/create-fields?dryRun=1');
        const data = await response.json();
        
        if (data.ok) {
          updateStatus('connected', 
            `‚úÖ Token v√°lido | Portal ID: ${data.portalId || 'N/A'} | Expira em: ${data.expires_at ? new Date(data.expires_at).toLocaleString('pt-BR') : 'N/A'}`, 
            'success'
          );
          btnCreate.disabled = false;
          btnTest.disabled = false;
          document.getElementById('step-2').classList.add('completed');
          log('Status verificado com sucesso', data);
        } else {
          updateStatus('disconnected', 
            `‚ö†Ô∏è ${data.message || 'Token n√£o configurado'}`, 
            'warning'
          );
          btnInstall.disabled = false;
          log('Sem token de acesso', data);
        }
      } catch (error) {
        updateStatus('disconnected', 
          '‚ùå Erro ao verificar status. Verifique as vari√°veis de ambiente.', 
          'error'
        );
        btnInstall.disabled = false;
        log('Erro ao verificar status', error);
      }
    }

    // Configurar bot√£o de instala√ß√£o
    btnInstall.addEventListener('click', () => {
      const clientId = prompt('Digite o HUBSPOT_CLIENT_ID:');
      if (!clientId) return;
      
      const redirectUri = window.location.origin + '/api/oauth/callback';
      const scopes = 'crm.objects.companies.write crm.schemas.companies.write';
      
      const authUrl = `https://app.hubspot.com/oauth/authorize?client_id=${clientId}&scope=${encodeURIComponent(scopes)}&redirect_uri=${encodeURIComponent(redirectUri)}`;
      
      log(`Redirecionando para OAuth: ${authUrl}`);
      window.location.href = authUrl;
    });

    // Configurar bot√£o de teste
    btnTest.addEventListener('click', async () => {
      try {
        btnTest.disabled = true;
        btnTest.innerHTML = '<div class="loading"></div> Testando...';
        log('Executando teste (dry run)...');
        
        const response = await fetch('/api/setup/create-fields?dryRun=1');
        const data = await response.json();
        
        if (data.ok) {
          log('‚úÖ Teste conclu√≠do com sucesso', data);
          updateStatus('connected', '‚úÖ Teste conclu√≠do! Campos prontos para serem criados.', 'success');
        } else {
          log('‚ùå Erro no teste', data);
          updateStatus('disconnected', `‚ùå Erro: ${data.message}`, 'error');
        }
      } catch (error) {
        log('‚ùå Erro ao executar teste', error);
      } finally {
        btnTest.disabled = false;
        btnTest.innerHTML = 'üß™ Teste (Dry Run)';
      }
    });

    // Configurar bot√£o de criar campos
    btnCreate.addEventListener('click', async () => {
      if (!confirm('Deseja criar os campos no HubSpot agora?')) return;
      
      try {
        btnCreate.disabled = true;
        btnCreate.innerHTML = '<div class="loading"></div> Criando...';
        log('Criando campos no HubSpot...');
        
        const response = await fetch('/api/setup/create-fields', {
          method: 'POST'
        });
        const data = await response.json();
        
        if (data.ok) {
          log('‚úÖ Campos criados com sucesso!', data);
          updateStatus('connected', 
            `‚úÖ Campos criados! Total: ${data.summary.total} | Criados: ${data.summary.created} | J√° existentes: ${data.summary.already_exists}`, 
            'success'
          );
          document.getElementById('step-3').classList.add('completed');
        } else {
          log('‚ùå Erro ao criar campos', data);
          updateStatus('connected', `‚ö†Ô∏è Alguns erros ocorreram: ${data.errors?.length || 0} campos falharam`, 'warning');
        }
      } catch (error) {
        log('‚ùå Erro ao criar campos', error);
      } finally {
        btnCreate.disabled = false;
        btnCreate.innerHTML = '‚ûï Criar Campos';
      }
    });

    // Inicializar
    checkStatus();
  </script>
</body>
</html>
