const express = require('express');
const axios = require('axios');
const app = express();

app.use(express.json());

const CLIENT_ID = process.env.CLIENT_ID;
const CLIENT_SECRET = process.env.CLIENT_SECRET;
let HUBSPOT_ACCESS_TOKEN = process.env.HUBSPOT_ACCESS_TOKEN;
const HUBSPOT_REFRESH_TOKEN = process.env.HUBSPOT_REFRESH_TOKEN;
const REDIRECT_URI = process.env.REDIRECT_URI;

// ⚡ VARIÁVEIS PARA PERSISTÊNCIA
let selectedDestinationField = 'teste_cnpj';
let savedUserChoice = null;

// ⚡ SISTEMA DE MAPEAMENTO INDIVIDUAL
let individualMapping = {
  telefone: null,
  razao_social: null,
  nome_fantasia: null,
  cidade: null,
  estado: null,
  atividade: null,
  cep: null,
  email: null,
  endereco: null,
  situacao: null,
  porte: null,
  capital_social: null
};

// ⚡ CAMPOS PADRÃO FIXOS (SEM BUSCAR API)
const HUBSPOT_STANDARD_FIELDS = [
  { text: '📝 Nome da empresa (name)', value: 'name', description: 'Campo padrão do HubSpot' },
  { text: '📝 Descrição (description)', value: 'description', description: 'Campo padrão do HubSpot' },
  { text: '📞 Telefone (phone)', value: 'phone', description: 'Campo padrão do HubSpot' },
  { text: '🏙️ Cidade (city)', value: 'city', description: 'Campo padrão do HubSpot' },
  { text: '🌎 Estado (state)', value: 'state', description: 'Campo padrão do HubSpot' },
  { text: '🌐 Website (website)', value: 'website', description: 'Campo padrão do HubSpot' },
  { text: '📮 CEP (zip)', value: 'zip', description: 'Campo padrão do HubSpot' },
  { text: '📋 Campo teste CNPJ (teste_cnpj)', value: 'teste_cnpj', description: 'Campo de teste para CNPJ' }
];

// ⚡ Definição dos 10 campos CRMHub
const CRMHUB_FIELDS = [
  {
    name: 'cnpj_enriquecido_crmhub',
    label: 'CNPJ Enriquecido CRMHub',
    type: 'string',
    fieldType: 'text',
    description: 'CNPJ formatado e validado pela CRMHub'
  },
  {
    name: 'telefone_enriquecido_crmhub',
    label: 'Telefone Enriquecido CRMHub',
    type: 'string',
    fieldType: 'text',
    description: 'Telefone da Receita Federal formatado'
  },
  {
    name: 'razao_social_crmhub',
    label: 'Razão Social CRMHub',
    type: 'string',
    fieldType: 'text',
    description: 'Razão Social oficial da Receita Federal'
  },
  {
    name: 'nome_fantasia_crmhub',
    label: 'Nome Fantasia CRMHub',
    type: 'string',
    fieldType: 'text',
    description: 'Nome fantasia da empresa'
  },
  {
    name: 'situacao_cadastral_crmhub',
    label: 'Situação Cadastral CRMHub',
    type: 'string',
    fieldType: 'text',
    description: 'Situação cadastral na Receita Federal'
  },
  {
    name: 'porte_empresa_crmhub',
    label: 'Porte da Empresa CRMHub',
    type: 'string',
    fieldType: 'text',
    description: 'Porte da empresa (Micro, Pequena, etc.)'
  },
  {
    name: 'atividade_principal_crmhub',
    label: 'Atividade Principal CRMHub',
    type: 'string',
    fieldType: 'textarea',
    description: 'Atividade principal CNAE da empresa'
  },
  {
    name: 'endereco_completo_crmhub',
    label: 'Endereço Completo CRMHub',
    type: 'string',
    fieldType: 'textarea',
    description: 'Endereço completo da sede da empresa'
  },
  {
    name: 'capital_social_crmhub',
    label: 'Capital Social CRMHub',
    type: 'string',
    fieldType: 'text',
    description: 'Capital social registrado na RF'
  },
  {
    name: 'data_atualizacao_crmhub',
    label: 'Data Atualização CRMHub',
    type: 'string',
    fieldType: 'text',
    description: 'Data da última atualização dos dados'
  }
];

// ⚡ Função para criar todos os campos CRMHub
async function createAllCRMHubFields() {
  if (!HUBSPOT_ACCESS_TOKEN) {
    throw new Error('Token do HubSpot não configurado');
  }

  console.log('🏗️ Iniciando criação dos campos CRMHub...');
  
  let created = 0;
  let existing = 0;
  const results = [];

  // Primeiro, criar o grupo
  try {
    await axios.post(
      'https://api.hubapi.com/crm/v3/properties/companies/groups',
      {
        name: 'crmhub_enriquecimento',
        label: 'CRMHub - Enriquecimento CNPJ',
        displayOrder: 1
      },
      {
        headers: {
          Authorization: `Bearer ${HUBSPOT_ACCESS_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );
    console.log('✅ Grupo CRMHub criado');
  } catch (error) {
    if (error.response?.status === 409) {
      console.log('⚠️ Grupo CRMHub já existe');
    } else {
      console.log('⚠️ Erro ao criar grupo:', error.response?.data?.message);
    }
  }

  // Criar cada campo
  for (const field of CRMHUB_FIELDS) {
    try {
      const fieldData = {
        ...field,
        groupName: 'crmhub_enriquecimento',
        hasUniqueValue: false,
        hidden: false,
        displayOrder: -1
      };

      await axios.post(
        'https://api.hubapi.com/crm/v3/properties/companies',
        fieldData,
        {
          headers: {
            Authorization: `Bearer ${HUBSPOT_ACCESS_TOKEN}`,
            'Content-Type': 'application/json'
          }
        }
      );

      created++;
      results.push(`✅ ${field.label} criado`);
      console.log(`✅ Campo criado: ${field.name}`);

    } catch (error) {
      if (error.response?.status === 409) {
        existing++;
        results.push(`⚠️ ${field.label} já existe`);
        console.log(`⚠️ Campo já existe: ${field.name}`);
      } else {
        results.push(`❌ Erro ao criar ${field.label}: ${error.response?.data?.message}`);
        console.error(`❌ Erro ao criar ${field.name}:`, error.response?.data);
      }
    }
  }

  return {
    created,
    existing,
    total: CRMHUB_FIELDS.length,
    results
  };
}

// ⚡ Função para verificar status dos campos CRMHub
async function checkCRMHubFieldsStatus() {
  if (!HUBSPOT_ACCESS_TOKEN) {
    throw new Error('Token do HubSpot não configurado');
  }

  console.log('🔍 Verificando status dos campos CRMHub...');
  
  const fieldsStatus = [];
  let existing = 0;
  let missing = 0;

  for (const field of CRMHUB_FIELDS) {
    try {
      await axios.get(
        `https://api.hubapi.com/crm/v3/properties/companies/${field.name}`,
        {
          headers: {
            Authorization: `Bearer ${HUBSPOT_ACCESS_TOKEN}`,
            'Content-Type': 'application/json'
          }
        }
      );

      fieldsStatus.push({
        name: field.name,
        label: field.label,
        status: 'exists'
      });
      existing++;

    } catch (error) {
      if (error.response?.status === 404) {
        fieldsStatus.push({
          name: field.name,
          label: field.label,
          status: 'missing'
        });
        missing++;
      } else {
        fieldsStatus.push({
          name: field.name,
          label: field.label,
          status: 'error',
          error: error.response?.data?.message
        });
      }
    }
  }

  return {
    fields: fieldsStatus,
    summary: {
      existing,
      missing,
      total: CRMHUB_FIELDS.length,
      allReady: missing === 0
    }
  };
}

// ⚡ Função melhorada para limpar CNPJ
function cleanCNPJ(cnpjInput) {
  console.log('🧹 Limpando CNPJ:', cnpjInput, 'Tipo:', typeof cnpjInput);
  
  if (!cnpjInput) {
    console.log('🧹 CNPJ vazio ou null');
    return '';
  }
  
  const cnpjString = String(cnpjInput).trim();
  const cleaned = cnpjString.replace(/[^\d]/g, '');
  
  console.log('🧹 CNPJ após limpeza:', cleaned, 'Tamanho:', cleaned.length);
  
  return cleaned;
}

// ⚡ Função para formatar dados do CNPJ em texto legível
function formatCNPJData(cnpjData, cnpjNumber) {
  const estabelecimento = cnpjData.estabelecimento || {};
  const endereco = estabelecimento.logradouro ? 
    `${estabelecimento.tipo_logradouro || ''} ${estabelecimento.logradouro}, ${estabelecimento.numero || 'S/N'}${estabelecimento.complemento ? ', ' + estabelecimento.complemento : ''}` : 
    'Não informado';
  
  const telefone = estabelecimento.telefone1 ? 
    `(${estabelecimento.ddd1}) ${estabelecimento.telefone1}` : 
    'Não informado';

  const formattedData = `
=== DADOS DA RECEITA FEDERAL ===
CNPJ: ${cnpjNumber}
Razão Social: ${cnpjData.razao_social || 'Não informado'}
Nome Fantasia: ${estabelecimento.nome_fantasia || 'Não informado'}
Situação Cadastral: ${estabelecimento.situacao_cadastral || 'Não informado'}
Data Situação: ${estabelecimento.data_situacao_cadastral || 'Não informado'}
Porte: ${cnpjData.porte?.descricao || 'Não informado'}
Capital Social: R$ ${cnpjData.capital_social || 'Não informado'}

=== ATIVIDADE ===
Atividade Principal: ${estabelecimento.atividade_principal?.descricao || 'Não informado'}

=== ENDEREÇO ===
Endereço: ${endereco}
Bairro: ${estabelecimento.bairro || 'Não informado'}
Cidade: ${estabelecimento.cidade?.nome || 'Não informado'}
Estado: ${estabelecimento.estado?.sigla || 'Não informado'}
CEP: ${estabelecimento.cep || 'Não informado'}

=== CONTATO ===
Telefone: ${telefone}
Email: ${estabelecimento.email || 'Não informado'}

=== INFORMAÇÕES ADICIONAIS ===
Data Início Atividade: ${estabelecimento.data_inicio_atividade || 'Não informado'}
Tipo: ${estabelecimento.tipo || 'Não informado'}
Natureza Jurídica: ${cnpjData.natureza_juridica?.descricao || 'Não informado'}

Atualizado em: ${new Date().toLocaleString('pt-BR')}
  `.trim();

  return formattedData;
}

// ⚡ ENDPOINTS PARA HUBSPOT APP

// Status do app
app.get('/account', (req, res) => {
  res.json({
    status: 'connected',
    app: 'CNPJ Enricher',
    version: '2.0',
    tokenStatus: HUBSPOT_ACCESS_TOKEN ? 'Configurado' : 'Não configurado',
    endpoints: {
      configurar: 'GET /settings',
      enriquecer: 'POST /enrich',
      criarTeste: 'POST /create-test-company'
    }
  });
});

// ⚡ NOVOS ENDPOINTS CRMHUB DROPDOWN - SIM/NÃO
app.post('/crmhub-dropdown-fetch', (req, res) => {
  console.log('🔽 CRMHub Dropdown Fetch chamado');
  
  try {
    const options = [
      {
        text: '✅ Sim - Criar campos CRMHub',
        value: 'sim',
        description: 'Criar 10 campos personalizados para dados do CNPJ'
      },
      {
        text: '❌ Não - Usar campo description',
        value: 'nao',
        description: 'Salvar todos os dados no campo description padrão'
      }
    ];

    console.log('📋 Retornando opções: Sim/Não');

    return res.json({
      response: {
        options: options,
        selectedOption: 'sim',
        placeholder: 'Criar campos CRMHub?'
      }
    });
    
  } catch (error) {
    console.error('❌ Erro no dropdown:', error);
    
    return res.json({
      response: {
        options: [
          { 
            text: '✅ Sim - Criar campos', 
            value: 'sim',
            description: 'Criar campos CRMHub'
          }
        ],
        selectedOption: 'sim',
        placeholder: 'Criar campos CRMHub?'
      }
    });
  }
});

app.post('/crmhub-dropdown-update', async (req, res) => {
  console.log('🔽 CRMHub Dropdown Update chamado');
  console.log('📥 Request body:', JSON.stringify(req.body, null, 2));
  
  try {
    const selectedOption = req.body.selectedOption || 'sim';
    
    console.log(`🎯 Opção selecionada: ${selectedOption}`);
    
    if (selectedOption === 'sim') {
      // Criar campos CRMHub
      try {
        const result = await createAllCRMHubFields();
        
        const message = `✅ Campos CRMHub configurados! ${result.created} criados, ${result.existing} já existiam. Total: ${result.total} campos.`;
        
        console.log('🎉 Campos CRMHub criados com sucesso');
        
        return res.json({
          response: {
            actionType: 'DROPDOWN_UPDATE',
            selectedOption: selectedOption,
            message: message,
            details: {
              created: result.created,
              existing: result.existing,
              total: result.total,
              results: result.results
            }
          }
        });
        
      } catch (error) {
        console.error('❌ Erro ao criar campos:', error);
        
        return res.json({
          response: {
            actionType: 'DROPDOWN_UPDATE',
            selectedOption: selectedOption,
            message: `❌ Erro ao criar campos: ${error.message}`,
            error: error.message
          }
        });
      }
      
    } else {
      // Configurar para usar campo description
      savedUserChoice = 'description';
      selectedDestinationField = 'description';
      
      const message = '✅ Configurado para usar campo "description" padrão do HubSpot para salvar dados do CNPJ.';
      
      console.log('📝 Configurado para usar campo description');
      
      return res.json({
        response: {
          actionType: 'DROPDOWN_UPDATE',
          selectedOption: selectedOption,
          message: message,
          configuration: {
            mode: 'description_field',
            field: 'description'
          }
        }
      });
    }
    
  } catch (error) {
    console.error('❌ Erro no dropdown update:', error);
    
    return res.json({
      response: {
        actionType: 'DROPDOWN_UPDATE',
        selectedOption: 'sim',
        message: '❌ Erro interno. Tente novamente.',
        error: error.message
      }
    });
  }
});

// ⚡ ROTAS ALTERNATIVAS PARA VERCEL (caso as principais não funcionem)
app.post('/api/crmhub-dropdown-fetch', (req, res) => {
  console.log('🔽 CRMHub Dropdown Fetch (rota alternativa) chamado');
  
  try {
    const options = [
      {
        text: '✅ Sim - Criar campos CRMHub',
        value: 'sim',
        description: 'Criar 10 campos personalizados para dados do CNPJ'
      },
      {
        text: '❌ Não - Usar campo description',
        value: 'nao',
        description: 'Salvar todos os dados no campo description padrão'
      }
    ];

    console.log('📋 Retornando opções: Sim/Não (rota alternativa)');

    return res.json({
      response: {
        options: options,
        selectedOption: 'sim',
        placeholder: 'Criar campos CRMHub?'
      }
    });
    
  } catch (error) {
    console.error('❌ Erro no dropdown (rota alternativa):', error);
    
    return res.json({
      response: {
        options: [
          { 
            text: '✅ Sim - Criar campos', 
            value: 'sim',
            description: 'Criar campos CRMHub'
          }
        ],
        selectedOption: 'sim',
        placeholder: 'Criar campos CRMHub?'
      }
    });
  }
});

app.post('/api/crmhub-dropdown-update', async (req, res) => {
  console.log('🔽 CRMHub Dropdown Update (rota alternativa) chamado');
  console.log('📥 Request body:', JSON.stringify(req.body, null, 2));
  
  try {
    const selectedOption = req.body.selectedOption || 'sim';
    
    console.log(`🎯 Opção selecionada: ${selectedOption} (rota alternativa)`);
    
    if (selectedOption === 'sim') {
      // Criar campos CRMHub
      try {
        const result = await createAllCRMHubFields();
        
        const message = `✅ Campos CRMHub configurados! ${result.created} criados, ${result.existing} já existiam. Total: ${result.total} campos.`;
        
        console.log('🎉 Campos CRMHub criados com sucesso (rota alternativa)');
        
        return res.json({
          response: {
            actionType: 'DROPDOWN_UPDATE',
            selectedOption: selectedOption,
            message: message,
            details: {
              created: result.created,
              existing: result.existing,
              total: result.total,
              results: result.results
            }
          }
        });
        
      } catch (error) {
        console.error('❌ Erro ao criar campos (rota alternativa):', error);
        
        return res.json({
          response: {
            actionType: 'DROPDOWN_UPDATE',
            selectedOption: selectedOption,
            message: `❌ Erro ao criar campos: ${error.message}`,
            error: error.message
          }
        });
      }
      
    } else {
      // Configurar para usar campo description
      savedUserChoice = 'description';
      selectedDestinationField = 'description';
      
      const message = '✅ Configurado para usar campo "description" padrão do HubSpot para salvar dados do CNPJ.';
      
      console.log('📝 Configurado para usar campo description (rota alternativa)');
      
      return res.json({
        response: {
          actionType: 'DROPDOWN_UPDATE',
          selectedOption: selectedOption,
          message: message,
          configuration: {
            mode: 'description_field',
            field: 'description'
          }
        }
      });
    }
    
  } catch (error) {
    console.error('❌ Erro no dropdown update (rota alternativa):', error);
    
    return res.json({
      response: {
        actionType: 'DROPDOWN_UPDATE',
        selectedOption: 'sim',
        message: '❌ Erro interno. Tente novamente.',
        error: error.message
      }
    });
  }
});

app.post('/accounts-fetch', (req, res) => {
  console.log('🔁 Recebido chamada de /accounts-fetch do HubSpot');

  return res.json({
    response: {
      accounts: [
        {
          accountId: 'default-account',
          accountName: 'Enriquecedor CNPJ - CRM Hub',
          accountLogoUrl: 'https://crmhub.com.br/wp-content/uploads/2025/02/logo-laranja-1.png'
        }
      ]
    }
  });
});

// ⚡ ENRICHMENT PRINCIPAL
app.post('/enrich', async (req, res) => {
  const { companyId } = req.body;

  console.log('🔍 Iniciando enriquecimento para companyId:', companyId);

  if (!companyId) {
    console.error('❌ Company ID não fornecido');
    return res.status(400).json({ error: 'Company ID is required' });
  }

  if (!HUBSPOT_ACCESS_TOKEN) {
    console.error('❌ HUBSPOT_ACCESS_TOKEN não configurado');
    return res.status(500).json({ 
      error: 'Token do HubSpot não configurado',
      details: 'Execute OAuth primeiro',
      authUrl: `https://app.hubspot.com/oauth/authorize?client_id=${CLIENT_ID}&scope=crm.objects.companies.read%20crm.objects.companies.write&redirect_uri=${REDIRECT_URI}`
    });
  }

  try {
    console.log('📡 Buscando empresa no HubSpot...');
    
    const hubspotCompany = await axios.get(
      `https://api.hubapi.com/crm/v3/objects/companies/${companyId}?properties=cnpj,name,domain,website,phone,city,state,country,createdate,hs_lastmodifieddate`,
      {
        headers: { 
          Authorization: `Bearer ${HUBSPOT_ACCESS_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );

    console.log('✅ Empresa encontrada no HubSpot');
    const properties = hubspotCompany.data.properties;
    
    console.log('🔍 Propriedades da empresa:');
    Object.keys(properties).forEach(key => {
      console.log(`${key}: "${properties[key]}"`);
    });
    
    // Buscar CNPJ
    let cnpjRaw = properties.cnpj || 
                  properties.CNPJ ||
                  properties.registration_number ||
                  properties.company_cnpj ||
                  properties.document_number ||
                  properties.tax_id ||
                  properties.federal_id;

    // Se não encontrou, procurar em qualquer campo com 14 dígitos
    if (!cnpjRaw) {
      console.log('🔍 CNPJ não encontrado nos campos padrão, procurando em todos os campos...');
      
      for (const [key, value] of Object.entries(properties)) {
        if (value && typeof value === 'string') {
          const cleaned = cleanCNPJ(value);
          if (cleaned.length === 14) {
            console.log(`🎯 CNPJ encontrado no campo "${key}": ${value} -> ${cleaned}`);
            cnpjRaw = value;
            break;
          }
        }
      }
    }

    console.log('🔍 CNPJ bruto encontrado:', cnpjRaw);

    const cnpjLimpo = cleanCNPJ(cnpjRaw);
    console.log('🧹 CNPJ limpo:', cnpjLimpo);

    if (!cnpjLimpo || cnpjLimpo.length !== 14) {
      console.warn('⚠️ CNPJ inválido ou não encontrado');
      
      let sugestoes = [];
      if (!cnpjRaw) {
        sugestoes.push('Campo CNPJ não encontrado na empresa');
        sugestoes.push(`Use: POST /add-cnpj/${companyId} com {"cnpj": "14665903000104"}`);
      } else if (cnpjLimpo.length !== 14) {
        sugestoes.push(`CNPJ tem ${cnpjLimpo.length} dígitos, precisa ter 14`);
        sugestoes.push('Formatos aceitos: 14665903000104 ou 14.665.903/0001-04');
      }
      
      return res.status(400).json({ 
        error: 'CNPJ inválido ou não encontrado',
        cnpjRaw: cnpjRaw,
        cnpjLimpo: cnpjLimpo,
        cnpjTamanho: cnpjLimpo.length,
        sugestoes: sugestoes
      });
    }

    console.log('📡 Buscando dados do CNPJ na API externa...');
    
    const cnpjDataResponse = await axios.get(`https://publica.cnpj.ws/cnpj/${cnpjLimpo}`, {
      timeout: 10000,
      headers: {
        'User-Agent': 'CNPJ-Enricher/2.0'
      }
    });

    console.log('✅ Dados do CNPJ obtidos com sucesso');
    const cnpjData = cnpjDataResponse.data;

    // Extrair dados principais
    const razaoSocial = cnpjData.razao_social || '';
    const nomeFantasia = cnpjData.estabelecimento?.nome_fantasia || '';
    const situacaoCadastral = cnpjData.estabelecimento?.situacao_cadastral || '';
    const porte = cnpjData.porte?.descricao || '';
    const atividadePrincipal = cnpjData.estabelecimento?.atividade_principal?.descricao || '';
    
    const telefoneFormatado = cnpjData.estabelecimento?.telefone1 ? 
      `(${cnpjData.estabelecimento.ddd1}) ${cnpjData.estabelecimento.telefone1}` : '';
    
    const emailCnpj = cnpjData.estabelecimento?.email || '';
    
    const enderecoCompleto = cnpjData.estabelecimento?.logradouro ? 
      `${cnpjData.estabelecimento.tipo_logradouro} ${cnpjData.estabelecimento.logradouro}, ${cnpjData.estabelecimento.numero}` : '';
    
    const cidade = cnpjData.estabelecimento?.cidade?.nome || '';
    const estado = cnpjData.estabelecimento?.estado?.sigla || '';
    const cep = cnpjData.estabelecimento?.cep || '';

    // Gerar dados formatados
    const dadosFormatados = formatCNPJData(cnpjData, cnpjLimpo);
    const campoAtual = savedUserChoice || selectedDestinationField;
    
    const updatePayload = {
      properties: {
        [campoAtual]: dadosFormatados
      }
    };

    console.log('📦 Payload final:', JSON.stringify(updatePayload, null, 2));
    console.log('📡 Atualizando empresa no HubSpot...');
    
    await axios.patch(
      `https://api.hubapi.com/crm/v3/objects/companies/${companyId}`,
      updatePayload,
      {
        headers: {
          Authorization: `Bearer ${HUBSPOT_ACCESS_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );

    console.log(`✅ Empresa atualizada com sucesso! Campo usado: ${campoAtual}`);
    
    const dadosEmpresa = {
      razaoSocial: razaoSocial,
      nomeFantasia: nomeFantasia,
      situacao: situacaoCadastral,
      porte: porte,
      cidade: cidade,
      estado: estado,
      atividade: atividadePrincipal,
      email: emailCnpj,
      telefone: telefoneFormatado
    };
    
    console.log('🎉 SUCESSO COMPLETO:');
    console.log('🏢 Razão Social:', dadosEmpresa.razaoSocial);
    console.log('✨ Nome Fantasia:', dadosEmpresa.nomeFantasia);
    console.log('📊 Situação:', dadosEmpresa.situacao);
    console.log('📍 Local:', `${dadosEmpresa.cidade}/${dadosEmpresa.estado}`);
    console.log('📞 Telefone:', dadosEmpresa.telefone);

    res.json({ 
      success: true,
      message: `🎉 Empresa enriquecida com sucesso! Campo usado: ${campoAtual}`,
      cnpj: cnpjLimpo,
      empresa: {
        razaoSocial: dadosEmpresa.razaoSocial,
        nomeFantasia: dadosEmpresa.nomeFantasia,
        situacao: dadosEmpresa.situacao,
        localizacao: `${dadosEmpresa.cidade}/${dadosEmpresa.estado}`,
        porte: dadosEmpresa.porte,
        contato: {
          email: dadosEmpresa.email,
          telefone: dadosEmpresa.telefone
        },
        atividade: dadosEmpresa.atividade
      },
      configuracao: {
        campoDestino: campoAtual,
        tipoConteudo: 'Texto formatado completo'
      }
    });

  } catch (error) {
    console.error('❌ Erro detalhado no enriquecimento:');
    console.error('📋 Mensagem:', error.message);
    console.error('📊 Status:', error.response?.status);
    console.error('📄 Response data:', error.response?.data);
    
    if (error.response?.status === 401) {
      return res.status(401).json({ 
        error: 'Token do HubSpot inválido ou expirado',
        details: 'Execute OAuth novamente',
        authUrl: `https://app.hubspot.com/oauth/authorize?client_id=${CLIENT_ID}&scope=crm.objects.companies.read%20crm.objects.companies.write&redirect_uri=${REDIRECT_URI}`
      });
    }
    
    if (error.response?.status === 404 && error.config?.url?.includes('hubapi.com')) {
      return res.status(404).json({ 
        error: 'Empresa não encontrada no HubSpot',
        companyId: companyId
      });
    }
    
    if (error.response?.status === 400 && error.response?.data?.message?.includes('does not exist')) {
      console.log('⚠️ Campo não existe no HubSpot');
      
      return res.status(400).json({ 
        error: `Campo ${campoAtual} não existe no HubSpot`,
        message: 'Execute POST /create-test-field para criar o campo',
        solucao: 'POST /create-test-field'
      });
    }
    
    if (error.response?.status === 429 && error.config?.url?.includes('cnpj.ws')) {
      console.log('⚠️ Rate limit atingido na API CNPJ');
      
      return res.status(200).json({ 
        success: true,
        message: '✅ CNPJ válido encontrado! Rate limit atingido (3 consultas/min)',
        cnpj: cnpjLimpo,
        empresaEncontrada: properties.name || 'Empresa sem nome',
        status: 'Aguardando liberação da API',
        proximaTentativa: 'Aguarde 1-2 minutos para nova consulta'
      });
    }
    
    if (error.config?.url?.includes('cnpj.ws')) {
      return res.status(500).json({ 
        error: 'Erro ao buscar dados do CNPJ',
        details: error.response?.data || error.message
      });
    }

    res.status(500).json({ 
      error: 'Erro ao enriquecer dados',
      details: error.message
    });
  }
});

// ⚡ Criar empresa de teste
app.post('/create-test-company', async (req, res) => {
  if (!HUBSPOT_ACCESS_TOKEN) {
    return res.status(401).json({ 
      error: 'Token não configurado',
      authUrl: `https://app.hubspot.com/oauth/authorize?client_id=${CLIENT_ID}&scope=crm.objects.companies.read%20crm.objects.companies.write&redirect_uri=${REDIRECT_URI}`
    });
  }

  try {
    console.log('🏢 Criando empresa de teste...');
    
    const response = await axios.post(
      'https://api.hubapi.com/crm/v3/objects/companies',
      {
        properties: {
          name: 'Empresa Teste CNPJ - ' + new Date().getTime(),
          cnpj: '14665903000104',
          domain: 'teste.com.br',
          phone: '11999999999',
          website: 'https://teste.com.br'
        }
      },
      {
        headers: {
          Authorization: `Bearer ${HUBSPOT_ACCESS_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );

    console.log('✅ Empresa criada com sucesso:', response.data.id);

    res.json({
      success: true,
      companyId: response.data.id,
      message: 'Empresa de teste criada com CNPJ 14665903000104',
      cnpj: '14665903000104',
      configuracao: {
        campoDestino: savedUserChoice || selectedDestinationField
      },
      proximoTeste: {
        url: 'POST /enrich',
        body: { companyId: response.data.id }
      }
    });
  } catch (error) {
    console.error('❌ Erro ao criar empresa teste:', error.response?.data);
    res.status(500).json({
      error: 'Erro ao criar empresa teste',
      details: error.response?.data
    });
  }
});

// ⚡ Criar campo teste_cnpj
app.post('/create-test-field', async (req, res) => {
  if (!HUBSPOT_ACCESS_TOKEN) {
    return res.status(401).json({ error: 'Token não configurado' });
  }

  try {
    console.log('🔧 Criando campo de teste teste_cnpj...');
    
    const response = await axios.post(
      'https://api.hubapi.com/crm/v3/properties/companies',
      {
        name: 'teste_cnpj',
        label: 'Teste CNPJ',
        type: 'string',
        fieldType: 'textarea',
        description: 'Campo de teste para dados do CNPJ - todos os dados da Receita Federal',
        groupName: 'companyinformation',
        hasUniqueValue: false,
        hidden: false,
        displayOrder: -1
      },
      {
        headers: {
          Authorization: `Bearer ${HUBSPOT_ACCESS_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );

    console.log('✅ Campo teste_cnpj criado com sucesso');
    
    res.json({
      success: true,
      message: 'Campo teste_cnpj criado com sucesso!',
      fieldName: 'teste_cnpj',
      fieldType: 'textarea'
    });
    
  } catch (error) {
    if (error.response?.status === 409) {
      console.log('⚠️ Campo teste_cnpj já existe');
      res.json({
        success: true,
        message: 'Campo teste_cnpj já existe no HubSpot',
        status: 'already_exists'
      });
    } else {
      console.error('❌ Erro ao criar campo teste_cnpj:', error.response?.data);
      res.status(500).json({
        error: 'Erro ao criar campo teste_cnpj',
        details: error.response?.data
      });
    }
  }
});

// ⚡ Adicionar CNPJ a uma empresa
app.post('/add-cnpj/:companyId', async (req, res) => {
  const { companyId } = req.params;
  const { cnpj } = req.body;

  if (!HUBSPOT_ACCESS_TOKEN) {
    return res.status(401).json({ error: 'Token não configurado' });
  }

  if (!cnpj) {
    return res.status(400).json({ error: 'CNPJ é obrigatório' });
  }

  try {
    console.log(`📝 Adicionando CNPJ ${cnpj} à empresa ${companyId}...`);
    
    const response = await axios.patch(
      `https://api.hubapi.com/crm/v3/objects/companies/${companyId}`,
      {
        properties: {
          cnpj: cnpj
        }
      },
      {
        headers: {
          Authorization: `Bearer ${HUBSPOT_ACCESS_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );

    console.log('✅ CNPJ adicionado com sucesso');
    
    res.json({
      success: true,
      message: `CNPJ ${cnpj} adicionado à empresa ${companyId}`,
      companyId: companyId,
      cnpj: cnpj,
      proximoPasso: {
        url: 'POST /enrich',
        body: { companyId: companyId }
      }
    });
    
  } catch (error) {
    console.error('❌ Erro ao adicionar CNPJ:', error.response?.data);
    res.status(500).json({
      error: 'Erro ao adicionar CNPJ',
      details: error.response?.data
    });
  }
});

// ⚡ Buscar empresas com CNPJ
app.get('/companies-with-cnpj', async (req, res) => {
  if (!HUBSPOT_ACCESS_TOKEN) {
    return res.status(401).json({ error: 'Token não configurado' });
  }

  try {
    console.log('🔍 Buscando empresas com CNPJ...');
    
    const response = await axios.get(
      'https://api.hubapi.com/crm/v3/objects/companies?properties=name,cnpj,domain,phone,city,state&limit=100',
      {
        headers: {
          Authorization: `Bearer ${HUBSPOT_ACCESS_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );

    const companies = response.data.results;
    const companiesWithCNPJ = companies.filter(company => {
      const cnpj = company.properties.cnpj;
      return cnpj && cleanCNPJ(cnpj).length === 14;
    });

    console.log(`✅ Encontradas ${companiesWithCNPJ.length} empresas com CNPJ válido`);
    
    res.json({
      success: true,
      total: companies.length,
      withCNPJ: companiesWithCNPJ.length,
      companies: companiesWithCNPJ.map(company => ({
        id: company.id,
        name: company.properties.name,
        cnpj: company.properties.cnpj,
        domain: company.properties.domain,
        phone: company.properties.phone,
        city: company.properties.city,
        state: company.properties.state
      }))
    });
    
  } catch (error) {
    console.error('❌ Erro ao buscar empresas:', error.response?.data);
    res.status(500).json({
      error: 'Erro ao buscar empresas',
      details: error.response?.data
    });
  }
});

// ⚡ Enriquecer todas as empresas com CNPJ
app.post('/enrich-all', async (req, res) => {
  if (!HUBSPOT_ACCESS_TOKEN) {
    return res.status(401).json({ error: 'Token não configurado' });
  }

  try {
    console.log('🚀 Iniciando enriquecimento em massa...');
    
    // Buscar empresas com CNPJ
    const companiesResponse = await axios.get(
      'https://api.hubapi.com/crm/v3/objects/companies?properties=name,cnpj&limit=100',
      {
        headers: {
          Authorization: `Bearer ${HUBSPOT_ACCESS_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );

    const companies = companiesResponse.data.results;
    const companiesWithCNPJ = companies.filter(company => {
      const cnpj = company.properties.cnpj;
      return cnpj && cleanCNPJ(cnpj).length === 14;
    });

    console.log(`📊 Encontradas ${companiesWithCNPJ.length} empresas para enriquecer`);

    let success = 0;
    let errors = 0;
    const results = [];

    for (const company of companiesWithCNPJ) {
      try {
        console.log(`🔄 Enriquecendo ${company.properties.name}...`);
        
        // Simular chamada de enriquecimento
        await new Promise(resolve => setTimeout(resolve, 1000)); // Rate limiting
        
        success++;
        results.push({
          id: company.id,
          name: company.properties.name,
          cnpj: company.properties.cnpj,
          status: 'success'
        });
        
      } catch (error) {
        errors++;
        results.push({
          id: company.id,
          name: company.properties.name,
          cnpj: company.properties.cnpj,
          status: 'error',
          error: error.message
        });
      }
    }

    console.log(`✅ Enriquecimento concluído: ${success} sucessos, ${errors} erros`);
    
    res.json({
      success: true,
      message: `Enriquecimento concluído: ${success} sucessos, ${errors} erros`,
      total: companiesWithCNPJ.length,
      successCount: success,
      errorCount: errors,
      results: results
    });
    
  } catch (error) {
    console.error('❌ Erro no enriquecimento em massa:', error.response?.data);
    res.status(500).json({
      error: 'Erro no enriquecimento em massa',
      details: error.response?.data
    });
  }
});

// ⚡ Configurações do app
app.get('/settings', (req, res) => {
  const settingsHtml = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNPJ Enricher - Configurações</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .status-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 25px;
            border-left: 5px solid #667eea;
            transition: transform 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
        }
        
        .status-card.success {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
        }
        
        .status-card.warning {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        }
        
        .btn {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn.success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        
        .btn.warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }
        
        .actions {
            text-align: center;
            margin: 40px 0;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
        }
        
        .endpoint-list {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 25px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
        }
        
        .endpoint-item {
            margin: 10px 0;
            padding: 10px;
            background: rgba(52, 73, 94, 0.5);
            border-radius: 5px;
            border-left: 3px solid #3498db;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚙️ CNPJ Enricher - Configurações</h1>
            <p style="color: #6c757d; font-size: 1.2em;">Sistema de Enriquecimento Automático</p>
        </div>
        
        <div id="status-section">
            <div class="loading">
                <div class="spinner"></div>
                <p>Carregando configurações...</p>
            </div>
        </div>
        
        <div class="actions">
            <h3>🚀 Ações Rápidas</h3>
            <button class="btn" onclick="checkStatus()">📊 Verificar Status</button>
            <button class="btn success" onclick="createTestCompany()">🏢 Criar Empresa Teste</button>
            <button class="btn warning" onclick="createTestField()">📋 Criar Campo Teste</button>
            <a href="/oauth/authorize" class="btn">🔐 Configurar OAuth</a>
        </div>
        
        <div class="endpoint-list">
            <h3>🔗 Endpoints Disponíveis</h3>
            <div class="endpoint-item">POST /enrich - Enriquecer empresa</div>
            <div class="endpoint-item">POST /create-test-company - Criar empresa teste</div>
            <div class="endpoint-item">POST /create-test-field - Criar campo teste_cnpj</div>
            <div class="endpoint-item">GET /companies-with-cnpj - Listar empresas com CNPJ</div>
            <div class="endpoint-item">POST /enrich-all - Enriquecer todas as empresas</div>
        </div>
        
        <div id="log-section" style="display: none;">
            <h3>📝 Log de Operações</h3>
            <div id="log" style="background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 8px; font-family: monospace; max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += \`[\${timestamp}] \${message}<br>\`;
            logElement.scrollTop = logElement.scrollHeight;
            document.getElementById('log-section').style.display = 'block';
        }
        
        async function checkStatus() {
            log('🔍 Verificando status do sistema...');
            
            try {
                const response = await fetch('/account');
                const data = await response.json();
                
                const statusSection = document.getElementById('status-section');
                const tokenStatus = data.tokenStatus === 'Configurado' ? 'success' : 'warning';
                
                statusSection.innerHTML = \`
                    <div class="status-grid">
                        <div class="status-card \${tokenStatus}">
                            <h4>🔐 Token HubSpot</h4>
                            <p><strong>\${data.tokenStatus}</strong></p>
                        </div>
                        <div class="status-card success">
                            <h4>📱 App Status</h4>
                            <p><strong>\${data.status}</strong></p>
                        </div>
                        <div class="status-card">
                            <h4>🔢 Versão</h4>
                            <p><strong>\${data.version}</strong></p>
                        </div>
                    </div>
                \`;
                
                log('✅ Status verificado com sucesso');
                
            } catch (error) {
                log(\`❌ Erro ao verificar status: \${error.message}\`);
            }
        }
        
        async function createTestCompany() {
            log('🏢 Criando empresa de teste...');
            
            try {
                const response = await fetch('/create-test-company', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(\`✅ Empresa criada: ID \${data.companyId}\`);
                    log(\`📋 CNPJ: \${data.cnpj}\`);
                } else {
                    log(\`❌ Erro: \${data.error}\`);
                }
                
            } catch (error) {
                log(\`❌ Erro ao criar empresa: \${error.message}\`);
            }
        }
        
        async function createTestField() {
            log('📋 Criando campo teste_cnpj...');
            
            try {
                const response = await fetch('/create-test-field', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(\`✅ Campo criado: \${data.fieldName}\`);
                } else {
                    log(\`❌ Erro: \${data.error}\`);
                }
                
            } catch (error) {
                log(\`❌ Erro ao criar campo: \${error.message}\`);
            }
        }
        
        // Verificar status automaticamente
        window.addEventListener('load', checkStatus);
    </script>
</body>
</html>`;

  res.send(settingsHtml);
});

// ⚡ OAuth Callback
app.get('/oauth/callback', async (req, res) => {
  const code = req.query.code;
  if (!code) return res.status(400).send('❌ Código de autorização não fornecido.');

  console.log('🔍 Processando OAuth callback...');

  try {
    if (!CLIENT_ID || !CLIENT_SECRET || !REDIRECT_URI) {
      console.error('❌ Variáveis de ambiente não configuradas');
      return res.status(500).send(`
        <h2>❌ Erro de Configuração</h2>
        <p><strong>CLIENT_ID:</strong> ${CLIENT_ID ? 'Configurado' : 'NÃO CONFIGURADO'}</p>
        <p><strong>CLIENT_SECRET:</strong> ${CLIENT_SECRET ? 'Configurado' : 'NÃO CONFIGURADO'}</p>
        <p><strong>REDIRECT_URI:</strong> ${REDIRECT_URI ? 'Configurado' : 'NÃO CONFIGURADO'}</p>
      `);
    }

    const response = await axios.post(
      'https://api.hubapi.com/oauth/v1/token',
      new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: CLIENT_ID,
        client_secret: CLIENT_SECRET,
        redirect_uri: REDIRECT_URI,
        code: code
      }),
      {
        headers: { 
          'Content-Type': 'application/x-www-form-urlencoded',
          'User-Agent': 'CNPJ-Enricher/2.0'
        },
        timeout: 10000
      }
    );

    const { access_token, refresh_token, expires_in } = response.data;
    HUBSPOT_ACCESS_TOKEN = access_token;

    console.log('✅ Access Token gerado:', access_token);
    console.log('⏰ Expira em (segundos):', expires_in);

    const successHtml = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Sucesso</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; background: #f8f9fa; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .success { color: #28a745; border-left: 4px solid #28a745; padding-left: 15px; margin-bottom: 20px; }
        .info { background: #e9ecef; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin: 10px 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="success">
            <h2>✅ Token OAuth gerado com sucesso!</h2>
        </div>
        
        <div class="info">
            <p><strong>Access Token:</strong> ${access_token.substring(0, 20)}...</p>
            <p><strong>Expira em:</strong> ${Math.floor(expires_in / 3600)} horas</p>
            <p><strong>Status:</strong> Conectado ao HubSpot ✅</p>
        </div>
        
        <h3>🚀 Próximos passos:</h3>
        <ol>
            <li><strong>Criar empresa teste:</strong><br><code>POST /create-test-company</code></li>
            <li><strong>Enriquecer empresa:</strong><br><code>POST /enrich</code></li>
            <li><strong>Verificar resultado:</strong><br>Confira o campo configurado</li>
        </ol>
        
        <div style="margin-top: 30px;">
            <a href="/account" class="btn">📊 Verificar Status</a>
        </div>
        
        <script>
            if (window.opener) {
                setTimeout(() => window.close(), 3000);
            }
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'oauth_success',
                    token: '${access_token.substring(0, 20)}...',
                    expiresIn: ${expires_in}
                }, '*');
            }
        </script>
    </div>
</body>
</html>`;

    res.send(successHtml);
    
  } catch (error) {
    console.error('❌ Erro no OAuth:', error.response?.data);
    res.status(500).send('❌ Erro ao gerar token OAuth');
  }
});

// ⚡ Página inicial com instruções
app.get('/', (req, res) => {
  const homeHtml = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNPJ Enricher 2.0</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 3.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.3em;
            margin: 10px 0;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .feature-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .btn {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn.success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        
        .actions {
            text-align: center;
            margin: 40px 0;
        }
        
        .endpoint-list {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 25px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
        }
        
        .endpoint-item {
            margin: 10px 0;
            padding: 10px;
            background: rgba(52, 73, 94, 0.5);
            border-radius: 5px;
            border-left: 3px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 CNPJ Enricher 2.0</h1>
            <p>Sistema Inteligente de Enriquecimento de Empresas</p>
            <p>Conecte ao HubSpot e enriqueça automaticamente com dados da Receita Federal</p>
        </div>
        
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">⚡</div>
                <h3>Cache Inteligente</h3>
                <p>Sistema de cache automático que evita consultas desnecessárias e melhora a performance</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">🛡️</div>
                <h3>Tratamento Robusto</h3>
                <p>Sistema avançado de tratamento de erros com mensagens claras e sugestões de solução</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">🔄</div>
                <h3>Rate Limiting</h3>
                <p>Controle automático de velocidade para respeitar os limites da API CNPJ</p>
            </div>
        </div>
        
        <div class="card">
            <h2>🎯 Como Usar</h2>
            <ol style="font-size: 1.1em; line-height: 1.6;">
                <li><strong>Configure OAuth:</strong> Conecte ao HubSpot usando OAuth 2.0</li>
                <li><strong>Crie empresa teste:</strong> Use o endpoint para criar uma empresa com CNPJ</li>
                <li><strong>Enriqueça dados:</strong> Execute o enriquecimento automático</li>
                <li><strong>Verifique resultados:</strong> Confira os dados no campo configurado</li>
            </ol>
        </div>
        
        <div class="actions">
            <a href="/settings" class="btn">⚙️ Configurações</a>
            <a href="/account" class="btn success">📊 Status do Sistema</a>
        </div>
        
        <div class="card">
            <div class="endpoint-list">
                <h3>🔗 Endpoints Principais</h3>
                <div class="endpoint-item">GET /account - Status do sistema</div>
                <div class="endpoint-item">POST /enrich - Enriquecer empresa</div>
                <div class="endpoint-item">POST /create-test-company - Criar empresa teste</div>
                <div class="endpoint-item">POST /create-test-field - Criar campo teste</div>
                <div class="endpoint-item">GET /companies-with-cnpj - Listar empresas</div>
                <div class="endpoint-item">POST /enrich-all - Enriquecimento em massa</div>
            </div>
        </div>
    </div>
</body>
</html>`;

  res.send(homeHtml);
});

console.log('🔧 Sistema CNPJ Enricher 2.0 carregado!');
console.log('🔽 Endpoints CRMHub Dropdown configurados!');

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`🚀 CNPJ Enricher 2.0 rodando na porta ${PORT}`));

module.exports = app;