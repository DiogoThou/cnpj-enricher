// ‚ö° ADICIONAR ESSAS FUN√á√ïES NO index.js - ANTES DOS ENDPOINTS

// ‚ö° SISTEMA DE AUTO-RENOVA√á√ÉO DE TOKEN
let tokenExpirationTime = null;
let tokenRefreshInProgress = false;

// ‚ö° FUN√á√ÉO PARA RENOVAR TOKEN AUTOMATICAMENTE
async function refreshAccessToken() {
  if (tokenRefreshInProgress) {
    console.log('üîÑ Renova√ß√£o j√° em andamento, aguardando...');
    return false;
  }

  if (!HUBSPOT_REFRESH_TOKEN) {
    console.error('‚ùå HUBSPOT_REFRESH_TOKEN n√£o configurado');
    return false;
  }

  tokenRefreshInProgress = true;

  try {
    console.log('üîÑ Renovando token do HubSpot...');
    
    const response = await axios.post(
      'https://api.hubapi.com/oauth/v1/token',
      new URLSearchParams({
        grant_type: 'refresh_token',
        client_id: CLIENT_ID,
        client_secret: CLIENT_SECRET,
        refresh_token: HUBSPOT_REFRESH_TOKEN
      }),
      {
        headers: { 
          'Content-Type': 'application/x-www-form-urlencoded',
          'User-Agent': 'CNPJ-Enricher/2.1'
        },
        timeout: 10000
      }
    );

    const { access_token, expires_in } = response.data;
    
    // ‚ö° ATUALIZAR TOKEN GLOBAL
    HUBSPOT_ACCESS_TOKEN = access_token;
    
    // ‚ö° CALCULAR TEMPO DE EXPIRA√á√ÉO (5 minutos antes para seguran√ßa)
    const expiresInMs = (expires_in - 300) * 1000; // 5 min antes
    tokenExpirationTime = Date.now() + expiresInMs;
    
    console.log('‚úÖ Token renovado com sucesso!');
    console.log(`üïê Pr√≥xima renova√ß√£o em: ${Math.floor(expires_in / 3600)}h${Math.floor((expires_in % 3600) / 60)}m`);
    console.log(`üîë Novo token: ${access_token.substring(0, 20)}...`);
    
    tokenRefreshInProgress = false;
    return true;
    
  } catch (error) {
    console.error('‚ùå Erro ao renovar token:', error.response?.data || error.message);
    tokenRefreshInProgress = false;
    return false;
  }
}

// ‚ö° FUN√á√ÉO PARA VERIFICAR SE TOKEN PRECISA SER RENOVADO
async function ensureValidToken() {
  if (!HUBSPOT_ACCESS_TOKEN) {
    console.log('‚ö†Ô∏è Token n√£o configurado');
    return false;
  }

  // ‚ö° SE N√ÉO SABEMOS QUANDO EXPIRA, ASSUMIR QUE PRECISA RENOVAR
  if (!tokenExpirationTime) {
    console.log('üîÑ Tempo de expira√ß√£o desconhecido, renovando token...');
    return await refreshAccessToken();
  }

  // ‚ö° VERIFICAR SE EST√Å PR√ìXIMO DO VENCIMENTO (5 minutos antes)
  const timeUntilExpiration = tokenExpirationTime - Date.now();
  const fiveMinutes = 5 * 60 * 1000;

  if (timeUntilExpiration <= fiveMinutes) {
    console.log('‚è∞ Token expirando em breve, renovando...');
    return await refreshAccessToken();
  }

  console.log(`‚úÖ Token v√°lido por mais ${Math.floor(timeUntilExpiration / 60000)} minutos`);
  return true;
}

// ‚ö° MIDDLEWARE PARA AUTO-RENOVA√á√ÉO EM TODAS AS CHAMADAS
async function withAutoTokenRefresh(apiCall) {
  try {
    // ‚ö° VERIFICAR E RENOVAR TOKEN SE NECESS√ÅRIO
    const tokenValid = await ensureValidToken();
    
    if (!tokenValid) {
      throw new Error('N√£o foi poss√≠vel renovar token');
    }

    // ‚ö° EXECUTAR CHAMADA ORIGINAL
    return await apiCall();
    
  } catch (error) {
    // ‚ö° SE DEU 401, TENTAR RENOVAR TOKEN UMA VEZ
    if (error.response?.status === 401 && !tokenRefreshInProgress) {
      console.log('üîÑ Token inv√°lido detectado, tentando renovar...');
      
      const renewed = await refreshAccessToken();
      
      if (renewed) {
        console.log('‚úÖ Token renovado, tentando novamente...');
        return await apiCall();
      }
    }
    
    throw error;
  }
}

// ‚ö° AUTO-RENOVA√á√ÉO PERI√ìDICA (A CADA 30 MINUTOS)
let tokenRefreshInterval = null;

function startTokenRefreshScheduler() {
  if (tokenRefreshInterval) {
    clearInterval(tokenRefreshInterval);
  }

  console.log('‚è∞ Iniciando scheduler de renova√ß√£o de token (30 min)');
  
  tokenRefreshInterval = setInterval(async () => {
    console.log('‚è∞ Verifica√ß√£o autom√°tica de token...');
    await ensureValidToken();
  }, 30 * 60 * 1000); // 30 minutos
}

function stopTokenRefreshScheduler() {
  if (tokenRefreshInterval) {
    clearInterval(tokenRefreshInterval);
    tokenRefreshInterval = null;
    console.log('‚èπÔ∏è Scheduler de token parado');
  }
}

// ‚ö° EXEMPLO DE USO - SUBSTITUIR CHAMADAS DIRETAS POR ESTAS:

// ‚ùå ANTES:
// const response = await axios.get(`https://api.hubapi.com/crm/v3/objects/companies/${companyId}`, {
//   headers: { Authorization: `Bearer ${HUBSPOT_ACCESS_TOKEN}` }
// });

// ‚úÖ DEPOIS:
// const response = await withAutoTokenRefresh(async () => {
//   return await axios.get(`https://api.hubapi.com/crm/v3/objects/companies/${companyId}`, {
//     headers: { Authorization: `Bearer ${HUBSPOT_ACCESS_TOKEN}` }
//   });
// });

// ‚ö° ENDPOINT MANUAL PARA RENOVAR TOKEN
app.post('/refresh-token-manual', async (req, res) => {
  try {
    const success = await refreshAccessToken();
    
    if (success) {
      res.json({
        success: true,
        message: '‚úÖ Token renovado com sucesso!',
        tokenPreview: HUBSPOT_ACCESS_TOKEN.substring(0, 20) + '...',
        expiresIn: tokenExpirationTime ? 
          Math.floor((tokenExpirationTime - Date.now()) / 60000) + ' minutos' : 
          'Tempo desconhecido'
      });
    } else {
      res.status(500).json({
        success: false,
        error: 'Falha ao renovar token'
      });
    }
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ‚ö° ENDPOINT PARA STATUS DO TOKEN
app.get('/token-status', (req, res) => {
  const hasToken = !!HUBSPOT_ACCESS_TOKEN;
  const hasRefreshToken = !!HUBSPOT_REFRESH_TOKEN;
  
  let timeUntilExpiration = null;
  if (tokenExpirationTime) {
    timeUntilExpiration = Math.floor((tokenExpirationTime - Date.now()) / 60000);
  }
  
  res.json({
    hasAccessToken: hasToken,
    hasRefreshToken: hasRefreshToken,
    tokenPreview: hasToken ? HUBSPOT_ACCESS_TOKEN.substring(0, 20) + '...' : null,
    expiresInMinutes: timeUntilExpiration,
    refreshSchedulerActive: !!tokenRefreshInterval,
    refreshInProgress: tokenRefreshInProgress,
    autoRefreshEnabled: hasRefreshToken && hasToken
  });
});

console.log('üîÑ Sistema de auto-renova√ß√£o de token carregado!');
console.log('üì° Endpoints adicionados:');
console.log('   POST /refresh-token-manual - Renovar token manualmente');
console.log('   GET /token-status - Status do token');
console.log('‚è∞ Scheduler autom√°tico ser√° iniciado no startup');
















üîÑ AGORA ATUALIZE SEUS ENDPOINTS PRINCIPAIS:


// ‚ö° ENDPOINT /enrich ATUALIZADO COM AUTO-RENOVA√á√ÉO
// SUBSTITUIR O ENDPOINT ATUAL POR ESTE:

app.post('/enrich', async (req, res) => {
  const { companyId } = req.body;

  console.log('üîç Iniciando enriquecimento para companyId:', companyId);

  if (!companyId) {
    console.error('‚ùå Company ID n√£o fornecido');
    return res.status(400).json({ error: 'Company ID is required' });
  }

  if (!HUBSPOT_ACCESS_TOKEN) {
    console.error('‚ùå HUBSPOT_ACCESS_TOKEN n√£o configurado');
    return res.status(500).json({ 
      error: 'Token do HubSpot n√£o configurado',
      details: 'Execute OAuth primeiro',
      authUrl: `https://app.hubspot.com/oauth/authorize?client_id=${CLIENT_ID}&scope=crm.objects.companies.read%20crm.objects.companies.write&redirect_uri=${REDIRECT_URI}`
    });
  }

  try {
    console.log('üì° Buscando empresa no HubSpot...');
    
    // ‚ö° USAR withAutoTokenRefresh PARA AUTO-RENOVA√á√ÉO
    const hubspotCompany = await withAutoTokenRefresh(async () => {
      return await axios.get(
        `https://api.hubapi.com/crm/v3/objects/companies/${companyId}?properties=cnpj,name,domain,website,phone,city,state,country,createdate,hs_lastmodifieddate`,
        {
          headers: { 
            Authorization: `Bearer ${HUBSPOT_ACCESS_TOKEN}`,
            'Content-Type': 'application/json'
          },
          timeout: 30000
        }
      );
    });

    console.log('‚úÖ Empresa encontrada no HubSpot');
    const properties = hubspotCompany.data.properties;
    
    console.log('üîç Propriedades da empresa:');
    Object.keys(properties).forEach(key => {
      console.log(`${key}: "${properties[key]}"`);
    });
    
    // Buscar CNPJ (